///////////////////////////////////////////////////////////
//  VocabloMontoSgteCuotaConvenio.cs
//  Implementation of the Class VocabloMontoSgteCuotaConvenio
//  Generated by Enterprise Architect
//  Created on:      13-May-2009 03:54:59 p.m.
//  Original author: Fernando
///////////////////////////////////////////////////////////
using System;
using scioPersistentLibrary;
using sgmpro.dominio.configuracion;

namespace toolsGestion.Vocablos {
    /// <summary>
    /// Devuelve el monto de la siguiente cuota del convenio.
    /// </summary>
    public class VocabloMontoSgteCuotaConvenio : Vocablo {
        /// <summary>
        /// Devuelve el resultado de Evaluar el vocablo
        /// para el objeto definido.
        /// Debe ser redefinido en cada clase.
        /// </summary>
        /// <param name="unObj">El objeto que se pretende Evaluar</param>
        /// <param name="unCriterio">Criterio que se evaluará (ej.<=,=,<>)</param>
        /// <param name="unValor">Valor que se comparará con el valor del Vocablo</param>
        /// <returns>Resultado de la evaluación</returns>
        public override bool Evaluar(object unObj, string unCriterio, string unValor) {
            _dt = null;

            string select =
            "select convert(float,isnull(sum((d.deu_capital+d.deu_interes+d.deu_honorarios+d.deu_gastos)),-999)) as resultado" +
            "  from deuda d" + " where d.deu_convenio = (select c.cvn_id" + 
            "                   		                   from convenio c" +
            "                   		                  where c.cvn_id = (select cta_convenioactivo  " +
            "                   					                          from cuenta  " +
            "                   						                     where cta_id = '" + unObj + "')" +
            "                    		                    and c.cvn_activo    = 1 " +
            "                   		                    and c.cvn_fechabaja = convert(datetime, '1753-01-01 00:00:000', 121))" +
            "   and d.deu_cuenta    is null" +
            "   and d.deu_estado    <> '" + _cancelada + "'" +
            "   and d.deu_fechabaja = convert(datetime, '1753-01-01 00:00:000', 121)" +
            "   and d.deu_fechavto  = (select min(e.deu_fechavto)" + 
            "                            from deuda e" +
            "                           where e.deu_fechavto > getdate()" +
            "                             and e.deu_estado   <> '" + _cancelada + "'" +
            "			                 and e.deu_fechabaja = convert(datetime, '1753-01-01 00:00:000', 121))";


            _dt = Persistencia.EjecutarSqlSelect(select, Persistencia.Controlador.CadenaConexion);

            return (_dt != null && _dt.Rows.Count > 0 &&
                    Comparar(((double)_dt.Rows[0]["resultado"]),
                        unCriterio,
                        Convert.ToInt64(unValor)));
        }
    }
}